{% extends 'base.html' %}
{% load static %}

{% block css%}
    <link rel="stylesheet" type="text/css" href={% static "perso/css/chain.css" %} />
{% endblock%}

{% block title%}
    - Chain
{% endblock %}

{% block jquery %}
<script>
    $(document).on('click', 'table.chain-categories td', function(e){
        e.preventDefault();
        var l = $(this).children("a").attr("href").split("/")[2];
        $( "#content-update" ).load( "/chain/"+l+"/", {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $("#content-update h2").addClass("grey");
        apiCalls = "";
        if (l == "jointReport" || l == "live" || l == "members") {
            apiCalls = " (1 API call)";
        } else if (l == "list") {
            apiCalls = " (1 API call if AA)";
        }
        $("#content-update h2").html('<i class="fas fa-spinner fa-pulse"></i>&nbsp;&nbsp;Loading '+l+apiCalls)
        $("div.error").hide();
    });

    // see report from list button
    $(document).on('click', '.chain-report-see-list', function(e){
        e.preventDefault();
        var chainId = this.href.split("/").pop();
        $( "#content-update" ).load( "/chain/report/"+chainId, {
            chainId: chainId,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $("#content-update h2").addClass("grey");
        $("#content-update h2").html('<i class="fas fa-spinner fa-pulse"></i>&nbsp;&nbsp;Loading report '+chainId)
    });

    // refresh/create report from list button
    $(document).on('click', '.chain-report-refresh-list', function(e){
        e.preventDefault();
        var chainId = this.href.split("/").pop();;
        var reload = $("#catch-buttons-"+chainId);
        reload.load( "/chain/createReport/"+chainId, {
            chainId: chainId,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    // delete report from list button
    $(document).on('click', '.chain-report-delete-list', function(e){
        e.preventDefault();
        var chainId = this.href.split("/").pop();;
        var reload = $("#catch-buttons-"+chainId);
        reload.load( "/chain/deleteReport/"+chainId, {
            chainId: chainId,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    // toggle report from list button
    $(document).on('click', '.chain-report-toggle-list', function(e){
        e.preventDefault();
        var chainId = this.href.split("/").pop();;
        var reload = $("#catch-buttons-"+chainId);
        reload.load( "/chain/toggleReport/"+chainId, {
            chainId: chainId,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    $(document).on('click', '#toggle-zero-hits', function(e){
        e.preventDefault();
        $(".zero-hits").slideToggle('fast', function() {});
        $(".zero-hits").promise().done(function() {
            var icon = $("#zero-hits-icon");
            if (icon.hasClass("fas fa-toggle-on")) {
                icon.removeClass("fas fa-toggle-on");
                icon.addClass("fas fa-toggle-off");
            } else {
                icon.removeClass("fas fa-toggle-off");
                icon.addClass("fas fa-toggle-on");
            }
        });
    });

    $(document).on('click', '#toggle-kicked-members', function(e){
        e.preventDefault();
        $(".kicked-members").slideToggle('fast', function() {});
        $(".kicked-members").promise().done(function() {
            var icon = $("#kicked-members-icon");
            if (icon.hasClass("fas fa-toggle-on")) {
                icon.removeClass("fas fa-toggle-on");
                icon.addClass("fas fa-toggle-off");
            } else {
                icon.removeClass("fas fa-toggle-off");
                icon.addClass("fas fa-toggle-on");
            }
        });
    });

    // show individual report
    $(document).on('click', 'tr[id^="chain-ireport-"] > td:not(.dont-touch-me)', function(e){
        e.preventDefault();
        var splt = $(this).closest("tr").attr("id").split("-");
        var memberId = splt.pop();
        var chainId = splt.pop();
        if( !$( "#individal-report-"+memberId ).length ) {
            $('<tr id="individal-report-'+memberId+'"></tr>').insertAfter($(this).closest('tr'));
        }
        var reload = $("#individal-report-"+memberId);
        reload.load( "/chain/renderIndividualReport/"+chainId+"/"+memberId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<td colspan="9" style="text-align: center;"><div class="loader"></div></td>');
    });

    // close individual report
    $(document).on('click', '[id^="individal-report-"]', function(e){
        e.preventDefault();
        $(this).html("");
    });


</script>
{% endblock %}

{% block content %}
    <div id="content-update">
        {% include "chain/content-reload.html" %}
    </div>

    <div class="catch-me">
        <h2 class="title grey toggle-display rounded"><i class="far fa-life-ring"></i>&nbsp;&nbsp;Tutorial&nbsp;&nbsp;<i class="fas fa-caret-right"></i></h2>
        <div class="module tutorial" style="display: none;">
            {% include "chain/tutorial.html" %}
            {% include "chain/tutorial-aa.html" %}
        </div>
    </div>
{% endblock %}
