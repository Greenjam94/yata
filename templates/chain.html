<!DOCTYPE html>
{% load static %}
{% load i18n %}
{% load humanize %}
{% load mathfilters %}
{% get_current_language as LANGUAGE_CODE %}

<!-- Current language: {{ LANGUAGE_CODE }} -->
<html lang="{{ LANGUAGE_CODE }}">
<head>

    <!-- load jquery from https://code.jquery.com/ -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

    <!-- css -->
    <link rel="stylesheet" type="text/css" href={% static "admin/css/base.css" %} />
    <link rel="stylesheet" type="text/css" href={% static "admin/css/forms.css" %} />
    <link rel="stylesheet" type="text/css" href={% static "perso/css/base.css" %} />

    <!-- jquery module to sort tables from http://tablesorter.com -->
    <script type="text/javascript" src={% static "perso/js/jquery.tablesorter.min.js" %}></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- scripts jquery perso -->
    <script>
        $(document).on('click', '.update-key', function(e){
            e.preventDefault();
            var key = $("#key-value").val();
            var check = $("#key-check-remember").is(':checked');
            var csrf = document.getElementsByName('csrfmiddlewaretoken')[0].value;
            $( "#api-key" ).html('<h2 class="title">Connecting to API</h2><div class="module whiteBG justTxt"><img src="https://www.torn.com/images/v2/main/ajax-loader.gif" alt="loader"/></div>');
            $( "#api-key" ).load( "{% url 'chain:updateKey' %}", {
                keyValue: key,
                html: "login",
                rememberSession: check,
                csrfmiddlewaretoken: csrf,
            });
        });

        $(document).ready(function() {
            $.tablesorter.addParser({
              // set a unique id
              id: 'since',
              is: function(s, table, cell, $cell) {
                // return false so this parser is not auto detected
                return false;
              },
              format: function(s, table, cell, cellIndex) {
                // format your data for normalization
                var ret = s.toLowerCase()
                          .replace(/days/,6)
                          .replace(/day/,5)
                          .replace(/hours/,4)
                          .replace(/hour/,3)
                          .replace(/minutes/,2)
                          .replace(/minute/,1)
                          .replace(/ago/,0).split(' ');
                return ret[1]+String('00000' + ret[0]).slice(-5);
              },
              // set type, either numeric or text
              type: 'numeric'
            });

            $("#chain-report-hits").tablesorter();
            $("#chain-members").tablesorter({
                headers: {
                    3: { sorter: "since" }
                },
                sortList: [[3,0], [2,1]],
            });
        });

        $(document).on('click', '#toggle-zero-hits', function(e){
            e.preventDefault();
            $(".zero-hits").slideToggle( 'slow', function() {} );
        });
        $(document).on('click', '#toggle-kicked-members', function(e){
            e.preventDefault();
            $(".kicked-members").slideToggle( 'slow', function() {} );
        });

        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
          var data = google.visualization.arrayToDataTable([
            ['Time', '# of hits / {{graph.info|floatformat:1}} minutes', { role: 'style' }, '# of commmulative hits'],
            {% for a,b,c in graph.data %}
                [new Date({{a|date:"Y"}}, {{a|date:"n"}}, {{a|date:"j"}}, {{a|date:"G"}}, {{a|date:"i"}}, {{a|date:"s"}}), {{b}}, {% if b < 2 %}'fill-color: #cc0000'{% else %}'fill-color: #787878'{% endif %}, {{c}}],
             {% endfor %}
          ]);

          var options = {
            // bar: {groupWidth: "100%"},
            legend: {position: 'top', textStyle: {fontSize: 14}},
            seriesType: 'bars',
            series: {
                      0: {type: 'bar', targetAxisIndex: 0, color: '#787878'},
                      1: {type: 'line', targetAxisIndex: 1, color: '#0000cc'},
                     },
            'backgroundColor': 'transparent',
            'chartArea': {'width': '90%', 'height': '70%'},
          };

          var view = new google.visualization.DataView(data);
          view.setColumns([0, 1]);

          var chart = new google.visualization.ComboChart(document.getElementById('histogram'));

          chart.draw(data, options);
        }


    </script>


    <!-- favicon -->
    <link rel="icon" type="image/png" href={% static "images/items/268/small.png" %} />

    <!-- meta  -->
    <meta name="robots" content="NONE,NOARCHIVE" />
    <meta charset="UTF-8">

    <title>Yet Another Torn App</title>
</head>

<body>
    <div id="details"></div>

    <div id="container">
        <div id="content">
            <h1><b>Y</b>et <b>A</b>nother <b>T</b>orn <b>A</b>pp</h1>
            <p><b>Chain reports</b>: who's been a good chainer?</p>
            <br />

            <div id="api-key">
                {% include "chain/login.html" %}
            </div>

            {% if onTheFlyMessage %}
                <div class="module">
                    <div class="errornote validnote">
                        <ul>
                        {% for message  in onTheFlyMessage %}
                            <li>{{message}}</li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}


            {% if view.liveReport %}
                <div id="chain-live">
                    {% include "chain/live.html" %}
                </div>
            {% endif %}

            {% if view.report %}
                <div id="chain-report">
                    {% include "chain/report.html" %}
                </div>
            {% endif %}

            {% if view.jointReport %}
                <div id="chain-report">
                    {% include "chain/jreport.html" %}
                </div>
            {% endif %}

            {% if view.list %}
                <div id="list-chains">
                    {% include "chain/list.html" %}
                </div>
            {% endif %}

            {% if view.members %}
                <div id="faction-members">
                    {% include "chain/members.html" %}
                </div>
            {% endif %}

            {% if view.tree %}
                <div id="chain-tree">
                    {% include "chain/tree.html" %}
                </div>
            {% endif %}


        </div> <!--end of content-->
    </div> <!--end of container-->
</body>
</html>
