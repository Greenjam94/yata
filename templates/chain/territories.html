{% comment %}
Copyright 2019 kivou.2000607@gmail.com

This file is part of yata.

    yata is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    any later version.

    yata is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with yata. If not, see <https://www.gnu.org/licenses/>.
{% endcomment %}

{% load humanize %}
{% load mathfilters %}
{% load static %}
{% load app_filters %}

{% if territories|length %}

<script>
    $(document).ready(function() {
        $.tablesorter.addParser({
            // set a unique id
            id: 'dataVal',
            // check if cell value has a numerical value
            is: function(s, table, cell, $cell) {
                return !isNaN($cell.attr("data-val"));
            },
            // format data for normalization
            format: function(s, table, cell, cellIndex) {
                return parseInt($(cell).attr("data-val"));
            },
            // set type, either numeric or text
            type: 'numeric'
        });

        $("#territory-list").tablesorter({cssAsc: 'up', cssDesc: 'down', sortList: [[4, 1], [0,0]]});
        $("#racket-list").tablesorter({cssAsc: 'up', cssDesc: 'down', sortList: [[7,0]]});
    });

      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['x', 'y', {'type': 'string', 'role': 'style'}, {role: 'tooltip', 'p': {'html': true}}],
          {% for t in allTerritories %}
          [ {{t.coordinate_x|mul:1.04}}, {{t.coordinate_y}}, 'point {fill-color: none;}', '{{t|tTooltip|safe}}'],
          {% endfor %}
          {% for t in territories %}
            [ {{t.coordinate_x|mul:1.04}}, {{t.coordinate_y}}, 'point {shape-type: square; fill-color: #0B8E14; stroke-color: #000; size: 6;}', '{{t|tTooltip|safe}}'],
          {% endfor %}
          {% for t in rackets %}
            [ {{t.coordinate_x|mul:1.04}}, {{t.coordinate_y}}, 'point {shape-type: star; fill-color: #CC3434; stroke-color: #000; size: 8;}', '{{t|rTooltip|safe}}'],
          {% endfor %}
          [ {{summary.coordinate_x|mul:1.04}}, {{summary.coordinate_y}}, 'point {shape-type: star; fill-color: #447e9b; stroke-color: #000; size: 8;}', '{{summary|sTooltip|safe}}'],
        ]);

        // var minV = 0.9 * Math.min(data.getColumnRange(1).min, data.getColumnRange(0).min);
        // var maxV = 1.1 * Math.max(data.getColumnRange(1).max, data.getColumnRange(0).max);
        var options = {
          // title: 'Territory and racket map',
          tooltip: {isHtml: true, position: 'top'},
          vAxis: {
              viewWindow:{ max: 0, min: 3500 },
              baselineColor: 'none',
              textPosition: 'none',
              gridlines: { color: '#999' },
              direction: -1
          },
          hAxis: {
                viewWindow:{ max: 0, min: 6500 },
                baselineColor: 'none',
                textPosition: 'none',
                gridlines: { color: '#999' },
            },
          'chartArea': {'width': '100%', 'height': '100%'},
          'backgroundColor': 'transparent',
          legend: 'none'
        };

        var chart = new google.visualization.ScatterChart(document.getElementById('map-graph'));

        chart.draw(data, options);
      }

</script>

<div class="module rounded">
    <span class="neutral"><i class="fas fa-info-circle"></i>&nbsp;&nbsp;Work in progress</span>
</div>

<h2 class="title">Map</h2>
<div class="module">
    <div id='map-background' class='map-background'>
        <div id="map-graph" class='map-graph'></div>
    </div>
</div>

<h2 class="title">List of territories</h2>
<div class="module">




    <table class="center tdshadow territory-summary">
        <thead>
            <tr><th colspan="3">Summary of territories</th></tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">You have <b>{{summary.n}}</b> territories for <b>{{summary.daily_respect|floatformat:0}}</b> daily respects</td>
            </tr>
            <tr>
                <td>Barycenter</td>
                <td><b>x = {{summary.coordinate_x|floatformat:2}}</b></td>
                <td><b>y = {{summary.coordinate_y|floatformat:2}}</b></td>
            </tr>
        </tbody>
    </table>
    <table id="territory-list" class="tablesorter center-large trshadow territory-list">
        <thead>
            <tr>
                <th>Territory</th>
                <th>Sector</th>
                <th>Size</th>
                <th>Density</th>
                <th>Daily Respect</th>
                <th>X</th>
                <th>Y</th>
                <th>Racket</th>
        </thead>
        <tbody>
        {% for territory in territories %}
        <tr class="{% if territory.racket %}racket{% endif %}">
            <td class="a">{{territory.tId}}</td>
            <td class="a">{{territory.sector}}</td>
            <td class="a">{{territory.size}}</td>
            <td class="a">{{territory.density}}</td>
            <td class="a">{{territory.daily_respect}}</td>
            <td class="a">{{territory.coordinate_x|floatformat:2}}</td>
            <td class="a">{{territory.coordinate_y|floatformat:2}}</td>
            <td class="b">{{territory.racket}}</td>
        {% endfor %}
        </tbody>
    </table>
</div>

<h2 class="title">List of Rackets</h2>
<div class="module">
    <table id="racket-list" class="tablesorter center-large trshadow racket-list">
        <thead>
            <tr>
                <th>Territory</th>
                <th>Racket</th>
                <th>Reward</th>
                <th>Level</th>
                <th>Created</th>
                <th>Changed</th>
                <th>Faction</th>
                <th>Distance</th>
        </thead>
        {% for racket in rackets %}
            {% if player.factionId != racket.faction %}
            <tr>
                <td class="a">{{racket.tId}}</td>
                <td class="b">{{racket.name}}</td>
                <td class="b">{{racket.reward}}</td>
                <td class="a">{{racket.level}}</td>
                <td class="c" data-val="{{racket.created}}">{{racket.created|ts2date}}</td>
                <td class="c" data-val="{{racket.changed}}">{{racket.changed|ts2date}}</td>
                {% if racket.faction %}
                    <td class="b"><a href="https://www.torn.com/factions.php?step=profile&ID={{racket.faction}}" target="_blank">{{racket.factionName}} [{{racket.faction}}]</a></td>
                {% else %}
                    <td class="b">"-"</td>
                {% endif %}
                <td class="a" title="Position: {{racket.coordinate_x}} x {{racket.coordinate_y}}">{{racket.distance|floatformat:2}}</td>
            </tr>
            {% endif %}
        {% endfor %}
        </tbody>
    </table>


</div>

{% else%}
<h2 class="title">List of territories</h2>
<div class="module">
    <p class="error">Your faction has no territories</p>
</div>
{% endif %}
