{% extends 'base.html' %}
{% load static %}

{% block css%}
    <link rel="stylesheet" type="text/css" href={% static "perso/css/bazaar.css" %} />
{% endblock%}

{% block title%}
    - Bazaar
{% endblock %}

{% block jquery %}
<script>
    $(document).on('click', 'table.bazaar-categories td', function(e){
        e.preventDefault();
        var l = $(this).children("a").attr("href").split("/")[2];
        $( "#content-update" ).load( "/bazaar/"+l+"/", {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $("#content-update h2").html('<i class="fas fa-spinner fa-pulse"></i>&nbsp;&nbsp;Loading prices')
        $("#content-update h2").addClass("grey");
        $("div.error").hide();
    });

    // show/hide details item
    $(document).on('click', '.details-item', function(e){
        e.preventDefault();
        var tId = $(this).attr("href").split("/").pop();
        $( "#details-item" ).load( "/bazaar/details/"+tId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
    });
    $(document).on('click', '.close', function(e){
        e.preventDefault();
        $(this).parent("div.container").css("display", "none");
    });

    // update item
    $(document).on('click', '.update-item', function(e){
        e.preventDefault();
        var tId = $(this).attr("href").split("/").pop();
        $( "#item-sell-table-" + tId ).load( "/bazaar/update/"+tId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $(this).children("button").html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    // update type
    $(document).on('click', '.update-type', function(e){
        e.preventDefault();
        var tType = $(this).attr("href").split("/").pop();
        $("#loop-over-item-sell-table-"+tType).find('table[id^="item-sell-table-"]').each(function() {
            var tId = $(this).attr("id").split("-").pop();
            $(this).load( "/bazaar/update/"+tId, {
                csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
            });
            $(this).find("button").html('<i class="fas fa-spinner fa-pulse"></i>');
        });
    });

    // delete item
    $(document).on('click', '.delete-item', function(e){
        e.preventDefault();
        var tId = $(this).attr("href").split("/").pop();
        $( "#item-sell-table-" + tId ).load( "/bazaar/delete/"+tId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $(this).closest("thead").children("tr:first-child").children("th").children("form").children("a").children("button").html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    // toggle item
    $(document).on('click', '.toggle-item', function(e){
        e.preventDefault();
        var tId = $(this).attr("href").split("/").pop();
        $( "#item-sell-table-" + tId ).load( "/bazaar/toggle/"+tId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $(this).closest("thead").children("tr:first-child").children("th").children("form").children("a").children("button").html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    // show/hide
    $(document).on('click', 'h2.toggle-display', function(e){
        e.preventDefault();
        var h = $(this);
        if (!($(e.target).hasClass("update-type") && !h.hasClass("rounded"))) {
            var i = h.find("i.fa-caret-right");
            var div = h.closest(".catch-me").children("div");
            if(div.css("display") == "none") {
                h.removeClass("rounded");
                i.addClass("fa-rotate-90");
            }
            div.slideToggle("fast", function(){
                if(div.css("display") == "none") {
                    h.addClass("rounded");
                    i.removeClass("fa-rotate-90");
                }
            });
        }
    });


    // refresh timer target update
    window.setInterval(function(){
        $("a.update-timer").each(function() {
            table = $(this).closest("table");
            var updatetime = $.trim($(this).text());
            if ( updatetime.search(" s")!=-1 ) {
                var splt = updatetime.split(" ");
                var seconds = 0;
                if (splt.length == 2) {
                    seconds = parseInt(splt[0]);
                } else if (splt.length == 4) {
                    seconds = parseInt(splt[2]) + 60 * parseInt(splt[0]);
                }
                if ( seconds > 599 ) {
                    $(this).html("> 10 mins");
                    // table.addClass("old-refresh");
                } else {
                    seconds ++;
                    minutes = Math.floor(seconds / 60);
                    seconds = seconds % 60;
                    if (minutes) {
                        spad = ("0"+seconds.toString()).slice(-2);
                        $(this).html(minutes.toString()+" mins "+spad+" s");
                    } else {
                        $(this).html(seconds.toString()+" s");
                    }
                    // table.removeClass("old-refresh");
                }
            }
            // else {
            //     if (!table.hasClass('old-refresh')) {
            //         table.addClass('old-refresh');
            //     }
            // }
        });
    }, 1000);

</script>
{% endblock %}

{% block content %}
    <div id="details-item"></div>

    <div id="content-update">
        {% include "bazaar/content-reload.html" %}
    </div>

{% endblock %}
