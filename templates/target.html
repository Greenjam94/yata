{% extends 'base.html' %}
{% load static %}

{% block css%}
    <link rel="stylesheet" type="text/css" href={% static "perso/css/target.css" %} />
{% endblock%}

{% block title%}
    - Target
{% endblock %}

{% block jquery %}
<script>
    $(document).on('click', 'table.target-categories td', function(e){
        e.preventDefault();
        var l = $(this).children("a").attr("href").split("/")[2];
        $( "#content-update" ).load( l+"/", {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $("#content-update h2").addClass("grey");
        $("#content-update h2").html('<i class="fas fa-spinner fa-pulse"></i>&nbsp;&nbsp;Loading '+l)
    });

    // toggle target from attack list button
    $(document).on('click', '.attack-list-toggle', function(e){
        e.preventDefault();
        var targetId = this.href.split("/").pop();
        var reload = $(".catch-buttons-attack-"+targetId);
        reload.load( "/target/toggleTarget/"+targetId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<i class="fas fa-spinner fa-pulse"></i>');
    });

    // refresh target from target list by clicking on the row
    $(document).on('click', 'tr[id^="target-list-refresh-"] > td:not(.dont-touch-me)', function(e){
        e.preventDefault();
        var reload = $(this).closest("tr");
        var targetId = reload.attr("id").split("-").pop();
        // alert(targetId);
        reload.load( "/target/refresh/"+targetId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<td colspan="13" style="text-align: center;"><i class="fas fa-spinner fa-pulse"></i></td>');
    });


    // delete target from target list button
    $(document).on('click', 'a.target-list-delete', function(e){
        e.preventDefault();
        var targetId = $(this).attr("href").split("/").pop();
        var reload = $("#target-list-refresh-"+targetId);
        reload.load( "/target/delete/"+targetId, {
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<td colspan="13" style="text-align: center;"><i class="fas fa-spinner fa-pulse"></i></td>');
    });


    // delete target from target list button
    $(document).on('focusout', 'input.target-list-note', function(e){
        e.preventDefault();
        var targetId = $(this).next("input").attr("value");
        var note = $(this).val();
        var reload = $(this).closest('td');
        // alert(targetId+notes)
        reload.load( "/target/updateNote/", {
            targetId: targetId,
            note: note,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        reload.html('<i class="fas fa-spinner fa-pulse" style="margin-top: 8px"></i>');
    });

    // add key
    $(document).on('click', '#target-add-submit', function(e){
        e.preventDefault();
        var id = $("#target-add-id").val();
        $( "#content-update" ).load( "/target/add/", {
            targetId: id,
            csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
        });
        $("#content-update h2").addClass("grey");
        $("#content-update h2").html('<i class="fas fa-spinner fa-pulse"></i>&nbsp;&nbsp;Adding target id '+id+' (1 API call)')

    });


    // refresh timer target update
    window.setInterval(function(){
        $(".update-timer").each(function() {
            var updatetime = $.trim($(this).text());
            if ( updatetime.search("s")!=-1 ) {
                var seconds = parseInt(updatetime.replace(" ", "").replace("s", ""));
                if ( seconds > 599 ) {
                    $(this).html("10 min");
                } else {
                    $(this).html((seconds+1).toString()+" s");
                }
            }
        });
    }, 1000);

    window.setInterval(function(){
        $(".update-timer").each(function() {
            var updatetime = $.trim($(this).text());
            if ( updatetime.search("min")!=-1 ) {
                var minutes = parseInt(updatetime.replace(" ", "").replace("min", ""));
                if ( minutes > 59 ) {
                    $(this).html("> 1h");
                } else {
                    $(this).html((minutes+1).toString()+" min");
                }
            }
        });
    }, 60000);


</script>
{% endblock %}

{% block content %}
    <div id="content-update">
        {% include "target/targets.html" %}
        {% include "target/attacks.html" %}
    </div>
    {% include "target/tutorial.html" %}
{% endblock %}
